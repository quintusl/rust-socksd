name: Create Release and Publish Assets

on:
  push:
    tags:
      - 'v*.*.*' # Trigger on version tags like v1.0.0, v1.2.3, etc.

jobs:
  create_gh_release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to create releases and upload assets
    outputs:
      pkg_name: ${{ steps.get_version.outputs.pkg_name }}
      version: ${{ steps.get_version.outputs.version }}
      tag_name: ${{ github.ref_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        # Example: v1.0.0 -> 1.0.0
        run: |
          export PKG_NAME=$(grep -A 10 '\[package\]' Cargo.toml | grep '^name *=' | sed 's/name *= *"\(.*\)"/\1/')
          echo "pkg_name=${PKG_NAME}" >> $GITHUB_OUTPUT
          echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release_step
        env:
          PKG_NAME: ${{ steps.get_version.outputs.pkg_name }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.get_version.outputs.version }}
        run: |
          gh release create ${{ github.ref_name }} \
            --title "Release ${{ github.ref_name }}" \
            --notes "Automated release for ${{ env.PKG_NAME }} version ${{ env.VERSION }}.
          See CHANGELOG.md for details (if available).
          Assets will be uploaded by subsequent jobs." \
            --draft=false \
            --prerelease=false

  build_and_upload_source_archive:
    name: Build and Upload Source Archive
    runs-on: ubuntu-latest
    needs: create_gh_release
    permissions:
      contents: write # Required to upload assets (read permission is implicit for checkout)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required by git archive to correctly use the tag

      - name: Create source archive
        id: create_source_archive
        env:
          PKG_NAME: ${{ needs.create_gh_release.outputs.pkg_name }}
          VERSION: ${{ needs.create_gh_release.outputs.version }}
          TAG_NAME: ${{ needs.create_gh_release.outputs.tag_name }}
        run: |
          ARCHIVE_NAME="${{ env.PKG_NAME }}-${VERSION}.tar.gz"
          # Create archive from the tagged commit, ensuring it extracts to a versioned directory
          git archive --format=tar.gz --prefix="${{ env.PKG_NAME }}-${VERSION}/" -o "${ARCHIVE_NAME}" "${TAG_NAME}"
          echo "archive_path=${PWD}/${ARCHIVE_NAME}" >> $GITHUB_OUTPUT
          echo "Created archive: ${ARCHIVE_NAME}"
          if [ -z "${PWD}/${ARCHIVE_NAME}" ]; then
            echo "::error::Archive path is empty. Check if the archive was created successfully."
            exit 1
          fi
          ls -lh "${ARCHIVE_NAME}"
          exit 0

      - name: Upload source archive to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARCHIVE_PATH: ${{ steps.create_source_archive.outputs.archive_path }}
        run: |
          gh release upload ${{ needs.create_gh_release.outputs.tag_name }} "${{ env.ARCHIVE_PATH }}"

  build_debian_packages:
    name: Build Debian Package
    runs-on: ubuntu-latest
    needs: create_gh_release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            qemu_arch: x86_64
          - arch: arm64
            qemu_arch: aarch64
          - arch: armhf
            qemu_arch: armv7
    steps:
      - uses: actions/checkout@v4

      - name: Build Debian Package on ${{ matrix.arch }}
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: ${{ matrix.qemu_arch }}
          distro: bookworm
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            apt-get install -y build-essential debhelper libssl-dev libpam0g-dev pkg-config curl git
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          run: |
            source $HOME/.cargo/env
            # Create a subdirectory for the build to ensure artifacts land in the workspace root (dpkg-buildpackage outputs to ../)
            mkdir -p package-build
            cp -r . package-build/
            cd package-build
            # Build the package (skip dependency check -d because we installed cargo via rustup)
            dpkg-buildpackage -b -uc -us -d
      
      - name: Upload Debian package to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ needs.create_gh_release.outputs.tag_name }}
        run: |
          # Find the .deb file in the workspace root (parent of package-build)
          DEB_PATH=$(find . -maxdepth 1 -name "*_${{ matrix.arch }}.deb" -print -quit)
          if [ -z "$DEB_PATH" ]; then
            echo "::error::Could not find .deb package for ${{ matrix.arch }}"
            ls -l
            exit 1
          fi
          echo "Found deb package: $DEB_PATH"
          gh release upload ${{ env.TAG_NAME }} "$DEB_PATH"

  aur_publish:
    name: "Publish Arch Linux source package to AUR"
    permissions:
      contents: read
    needs:
      - create_gh_release
      - build_and_upload_source_archive
    if: '!github.event.prerelease'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends git gettext-base

      - name: Generate PKGBUILD
        env:
          PKG_NAME: ${{ needs.create_gh_release.outputs.pkg_name }}
          PKG_VERSION: ${{ needs.create_gh_release.outputs.version }}
          TAG_NAME: ${{ needs.create_gh_release.outputs.tag_name }}
          PKGBUILD_TEMPLATE_PATH: ./AUR/PKGBUILD.in
          PKGBUILD_PATH: ./AUR/PKGBUILD
        run: |
          echo "Generating PKGBUILD at $PKGBUILD_PATH"
          /usr/bin/envsubst '${PKG_NAME} ${PKG_VERSION}' < "$PKGBUILD_TEMPLATE_PATH" > "$PKGBUILD_PATH"
          echo ""
          cat "$PKGBUILD_PATH"

      - name: Publish AUR package
        uses: KSXGitHub/github-actions-deploy-aur@v4.1.1
        with:
          pkgname: ${{ needs.create_gh_release.outputs.pkg_name }}
          pkgbuild: ./AUR/PKGBUILD
          assets: |
            ./AUR/*.install
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: Update AUR package
          ssh_keyscan_types: rsa,ecdsa,ed25519
